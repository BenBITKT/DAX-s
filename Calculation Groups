-- Calculation Groups are a way to organise measures in a matrix table
-- Normally in matrix tables, power bi will sort the columns like:

--Jan 24            Feb 24             Mar 24
--Quantity    Sales Quantity    Sales  Quantity    Sales

-- First step is to tell power bi to use 'calculation groups'

-- Open the desktop app and go to 'File \ Options and settings \ Options \ Preview features' and tick the box that says 'Model explorer and Calculation group authoring'. Click 'Ok' and then restart the desktop app

-- Open the desktop app and go to 'Model view' (the icon of the three boxes). Under 'Data \ Model' Click on 'Calculation groups' and select 'Add' then give the group a name eg 'Metrics'

-- This process will add a table with the name provided

-- Calculation groups will only apply to measures. So whatever needs to be in the table will need transferring to a measure. Eg Qty = SUM(... QUANTITY)

-- In the table will be a 'Calculation item' defaulted with the calculation '= SELECTEDMEASURE'. Change this to the calculation required eg Qty
-- Add new items for each measure required eg sales, profit average selling price

-- Go back to 'Report view' and the new group will be in a seperate table. Drag the group into the 'Columns' field on the visualizations pane then drag in one of the measures eg 'Qty'

-- We can also create a Calculation Group to add totals for the period, same period has last year and a Growth percentage


-- If the table calls for a comparsion against multiple metrics (like on BISON) then the varaince and variance% calcs need to be in the same calculation group as the metrics (see BISON 5.2 for more)

Qty Variance = 
    SUM(Buy_In_Sell_Out_Summary_Inc_STSPCODE_Details[Total_Buy_In_Qty]) - 
    SUM(Buy_In_Sell_Out_Summary_Inc_STSPCODE_Details[Total_Sell_Out_Qty])

Qty Variance % = 
    FORMAT(
    DIVIDE( SUM(Buy_In_Sell_Out_Summary_Inc_STSPCODE_Details[Total_Buy_In_Qty]) - 
        SUM(Buy_In_Sell_Out_Summary_Inc_STSPCODE_Details[Total_Sell_Out_Qty]) , 
        SUM(Buy_In_Sell_Out_Summary_Inc_STSPCODE_Details[Total_Buy_In_Qty]) 
    ),
    "percent")


-- If the table calls for a comparison on a single metrics (like in the Dealership Analysis - Sailun report) then follow the steps below:
-- Add a new calculation group and call KPI's

-- Change the Calculation item to Period and leave the calculuation as 'Period = SELECTEDMEASE()'

-- For the same period as last year add a new calculation item and use this calc:

LY = 
 IF(
    NOT ( ISINSCOPE('Sailun Dealerships'[Month])),
        CALCULATE(
            SELECTEDMEASURE(),
            SAMEPERIODLASTYEAR('Sailun Dealerships'[INVDATE].[Date])
        )
 )


-- For the Growth% use this calc:
Growth% = 
VAR CY = SELECTEDMEASURE()
VAR LY = 
    CALCULATE(
        SELECTEDMEASURE(),
        SAMEPERIODLASTYEAR( 'Sailun Dealerships'[INVDATE].[Date])
    )
RETURN
    IF(
        CY && LY && NOT ( ISINSCOPE('Sailun Dealerships'[Month])),
        DIVIDE( CY, LY ) - 1)


-- If using two calculaiton groups remember to stack then as Metrics, KPI's and Month Name in the 'Columns' pane

-- example report is SAIL
-- source link https://community.fabric.microsoft.com/t5/Community-Blog/Calculation-Groups-in-Power-BI/ba-p/3590905
